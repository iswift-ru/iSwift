# Делаем блокнот с заметками на Flutter и Firebase часть 1

Практически создаём упрощённый "клон" Google Keep с нуля
![Build a note-taking app with Flutter + Firebase — Part I](https://iswift.ru/images/1_6HTi-RPUL_cmp-UDURxpAg.gif)
Я поклонник [Google Keep](https://www.google.com/keep/), Я использую его с тех пор как он был запущен. В Keep я помещаю задачи с напоминанием по работе и другие необходимые напоминалки. Он интуитивный в использовании и помогает мне сфокусироваться на приорететах.
Так как я делаю [Flutter](https://flutter.dev/) приложения в течении двух последних лет, Я думаю, могло бы быть интересным сделать нечто похожее на Keep с самого нуля.

Так называемое ‘**Flutter Keep**’ приложение, которое я делаю, будет выглядеть следующим образом.

[![Flutter Keep](https://iswift.ru/images/2020-03-09_22-11-25.png)](https://youtu.be/GXNXodzgbcM)

Я представлю этот процесс разработки в серии статей. Ключевые компоненты будут добавлены в приложение в несколько циклов, это сделано для более лёгкого восприятия.

В первой части мы создадим Flutter проект, реализуем процесс аутенфикации и простой экран для показа списка записей.

Итак, приступим.

После создания проекта вы можете включить web поддержку с помощью команды: ```flutter config -- enable-web```, если вы хотите приложение, которое бы запускалось в Web помимо Android и iOS.  
Сейчас, выполните команду: ```flutter create flt_keep``` для создания Flutter Keep app, ```flt_keep``` это имя пакета, которое будет использовано при импорте

Те кто новички во Flutter, перейдите по ссылке [Get started guide](https://flutter.dev/docs/get-started/install) для установки SDK, и ознакомьтесь со структурой проекта.

## Структура

Для приложения "записная книжка" для начала надо определиться куда будут сохраняться и как будут вызываться записи.

Вот, что меня волнует:

* Первое. Конфидициальность. Записи других аккаунтов должны отделяться друг от друга.
* Второе. Приложени должно работать в офлайн. Пользователи, могли бы делать записи не находясь в зоне покрытия интернет. В обязанности приложения входит синхронизация данных при восстановлении сетевого подключения.

Мой выбор это [Cloud Firestore](https://firebase.google.com/docs/firestore), в основном потому что у меня был опыт использования в предыдущих приложениях а так же потмоу что он просто адаптируется.

Я решил использовать специальную коллекцию для хранения всех записей пользователей, одна заметка в одном документе.
Причины:
* Лучшая сегригация между данными аккаунтов.
* Легче делать запросы
* Постараться не выходить за [лимиты](https://firebase.google.com/docs/firestore/quotas#limits) на запись и чтение данных

Такой подход также сопровождается затратами, но он приемлем для демонстрационных целей. Т.е. я создам днамические индексы  для каждой коллекции, я обговорю эту проблему в следующем статье.

На данный момент структура данных выглядит следующим образом.
![Firestore data structure](https://iswift.ru/images/1_K11nEEwAPoEJnSexd22dRg.jpeg)
Firestore структура данных

## Архитектура приложения

Сейчас время рассмотреть как организовать логику в приложении. Не стоит применять "настоящую" архитектуру, данный пример структуры приложения для демонстрации. Но по-прежнему необходимо управлять состояниями на нескольких экранах приложения.

В нашем случаем, мы будем использовать пакет [provider](https://pub.dev/packages/provider) для управления состоянием приложения.  Это позволит нам писать код в стиле reactive (или data-driven) 

Наиболее важные экраны приложения:

* Экран авторизации, показывает состояние входа в систему, гарантирует, что только аутентифицированные пользователи могут делать заметки
* Экран со списком заметок, показывает последнее состояние заметок, должен реагировать на изменения в заметке.
* Редактор заметок также должен реагировать на внешние изменения редактируемой заметки.

Via providers, we can fulfill the above requirements easier, with a cleaner codebase.
С помощью Provider мы можем выполнять указанные выше требования с чистой кодовой базой.

С учётом схемы, начнём писать код.

Что бы использовать ```provider``` и Firebase SDKs, мы должны добавить зависимости в файл ```pubspec.yaml```:

```
provider: ^4.0.2
firebase_core: ^0.4.4
firebase_auth: ^0.15.4
cloud_firestore: ^0.13.3
google_sign_in: ^4.1.4
```
Пожалуйста перейдите по ссылке [Детальные инструкции](https://firebase.google.com/docs/flutter/setup) для интеграции Firebase SDKs с  Android и iOS, а так же с [Web платформой](https://firebase.google.com/docs/web/setup).

## Войдите в приложение
Помните, что мы должны отклонить неавторизованных пользователей, давайте сделаем корневой виджет.


<script src="https://gist.github.com/xinthink/7d1ad8cc4421f50266d3406342430c10.js"></script>
main.dart

```StreamProvider/Consumer``` здесь чтобы следить за ```onAuthStateChanged```, потоком событий авторизаций в Firebase, каждый раз когда меняется статус авторизации, ```Consumer``` будет принимать событие и перестраивать виджет согласно настоящего статуса.

Небольшая хитрость в том чтобы использовать ```CusttentUser``` переносить ```FirebaseUser```, чтобы различать начальное и неавторизованное состояния по умолчанию, оба из которых имеют значение ```null```.


<script src="https://gist.github.com/xinthink/9d0853544425791c1aee55eb78900b72.js"></script>
current_user.dart

## Google вход и Firebase авторизация
Я использую Google вход в примере, потмоу что его легко интегрировать. По сути, это всего лишь один из многочисленных сервисов, поддерживаемых Firebase авторизация. Вы можете включить что вам надо в Firebase консоли.
![Available authentication providers](https://iswift.ru/images/1_p28rWu_gssWRU4xwb5NTQg.png)
Available authentication providers

**Отрывок кода аутенфикации используя Google Sign-In:**  

<script src="https://gist.github.com/xinthink/3c2e2a93b54871ba72a4235ccf2f0554.js"></script>
login_screen.dart

Просто запрашиваем у Google учётные данные и используем их в аутенфикации в Firebase.

После удачной аутенфикации Вы ничего не увидите. В данной ситуации, ```FirebaseAuth.onAuthStateChanged``` поток выбрасывает событие ‘Signed-in’, который приводит в действие пересоздание корневого виджета, чтобы визуализировать ```HomeScreen```.

Выше в примере [Реактивное программирование](https://en.wikipedia.org/wiki/Reactive_programming): просто видоизменяется статус, слушатели которые интересуются статусом доделают оставшуюся работу.

Вернитесь к проекту, перед тестированием экрана входа убедитесь, что не игнорируются следующие параметры:

* Для Андройд платформы, вы должны [указать цифровой отпечаток SHA-1](https://firebase.google.com/docs/auth/android/google-signin#before_you_begin) в консоли Firebase
* Для ИОС платформы, вы [добавляете пользовательскую URL схему](https://firebase.google.com/docs/auth/ios/google-signin#2_implement_google_sign-in) в Xcode проекте
* Для Веб платформы, добавьте мета тег```<meta name="google-signin-client_id" content="{web_client_id}">``` в ```web/index.html```, вы можете найти Web client id в ‘OAuth 2.0 Client IDs’ раздела вашего проекта [страница учётных данных](https://console.cloud.google.com/apis/credentials) в Google Cloud консоли

## Запрашиваем заметки

Авторизованные пользователи переходят на главный экран со списком заметок.
Но как вы можете добавить первую заметку без редактора заметок? Вы должны сделать это в Firebase консоли:

![Firestore console](https://iswift.ru/images/1_JA5qv8JPFfjNA9zAQ3Nhcg.png)
Firestore console

Присвойте коллекции имя ```notes-{user_id}```, и вы сможете найти вашего пользователя на странице *Authentication* в Firebase консоли.

Для повышения безопасности конфиденциальности также может потребоваться установить правила доступа к набору данных, чтобы пользователи могли просматривать и редактировать только свои собственные заметки.

![Firestore data access rules](https://iswift.ru/images/1_8bNXjjHd9lQqAE-BKtPEsQ.png)
Firestore data access rules

Прежде чем мы сможем извлечь заметки из Firestore, нам нужна модель, представляющая отдельную заметку, и функции для преобразования между моделью Firestore и нашей собственной.

<script src="https://gist.github.com/xinthink/209fa3e9e37de1d9ae098101c12e2e5d.js"></script>

Мы снова должны использовать ```StreamProvider``` в ```HomeScreen```, который отслеживает результат запроса заметок так, чтобы любые изменения, происходящие с бэкэндом, отражались мгновенно. Firestore SDK так же обеспечивает [offline capabilities](https://firebase.google.com/docs/firestore/manage-data/enable-offline) Мы не должны изменять код, используемый для доступа к данным.

И благодаря корневому виджету созданного ранее, позволяет нам получить информацию об аутенфикации в любое время с
с помощью```Provider.of<CurrentUser>.```

<script src="https://gist.github.com/xinthink/4e04f2a3ecb3b5097fe0912fca898337.js"></script>
home_screen.dart

Немного подробный код, как я сделаю плавающий ```AppBar``` похожий на то что в Google Keep.

Для ```NotesGrid``` и ```NotesList```, они очень похожи: просто обертка ```SliverGrid``` и ```SliverList``` соответственно.

<script src="https://gist.github.com/xinthink/e972c4944bf197e60c98e19125f395bc.js"></script>
notes_grid.dart

Я не запостил весь код детально здесь. Пожалуйста, найдите полный пример в [GitHub репозитории](https://github.com/xinthink/flutter-keep).
Если всё было сделано правильно, вы можете увидеть первую заметку в вашем самодельном ***Flutter Keep*** приложении!


![Flutter Keep screenshot](https://iswift.ru/images/1_kov0KSVUbhuqVP3pCoebRw.png)
Flutter Keep screenshot

У нас пока всё хорошо. Мы делаем простое реактивное приложение используя пакет ```provider```, а так же учимся как использовать инструменты Firebase.

Однако приложение бесполезное не имея редактора заметок. Мы добавим больше функциональности в следующей части 2

Tспасибо что читали! 🙌

Автор Yingxin Wu
